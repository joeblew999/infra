<!DOCTYPE html>
<html lang="en">
<head>
    <title>Secrets Management - Infrastructure Management</title>
    {{.Header}}
    {{.DataStar}}
</head>
<body class="bg-white dark:bg-gray-900 text-base sm:text-lg max-w-4xl mx-auto px-4 sm:px-6 py-4 sm:py-8">
    {{.Navigation}}
    
    {{.ConfigSubNav}}

    <div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg px-4 sm:px-6 py-4 sm:py-8 ring shadow-xl ring-gray-900/5">
        <h1 class="text-2xl font-semibold mb-6">üîê Secrets Management</h1>
        
        <!-- Security Notice -->
        <div class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-l-4 border-yellow-500">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <span class="text-yellow-600 dark:text-yellow-400 text-xl">‚ö†Ô∏è</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
                        Security Notice
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
                        <p>Secrets are stored in your OS keychain (macOS Keychain, Windows Credential Manager, Linux Secret Service). 
                        This interface allows you to manage environment variables for deployment workflows.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secret Form -->
        <div class="mb-8 p-6 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <h2 class="text-lg font-semibold mb-4">Store New Secret</h2>
            
            <form id="secretForm" class="space-y-4">
                <div>
                    <label for="key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Environment Variable Name
                    </label>
                    <select id="key" name="key" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="FLY_API_TOKEN">FLY_API_TOKEN</option>
                        <option value="GITHUB_TOKEN">GITHUB_TOKEN</option>
                        <option value="FLY_APP_NAME">FLY_APP_NAME</option>
                        <option value="ANTHROPIC_AUTH_TOKEN">ANTHROPIC_AUTH_TOKEN</option>
                        <option value="CUSTOM">Custom Variable...</option>
                    </select>
                </div>
                
                <div id="customKeyField" class="hidden">
                    <label for="customKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Custom Variable Name
                    </label>
                    <input type="text" id="customKey" name="customKey" placeholder="Enter custom environment variable name"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="value" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Secret Value
                    </label>
                    <input type="password" id="value" name="value" placeholder="Enter secret value..." required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <button type="submit" 
                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    üîê Store in Keychain
                </button>
            </form>
            
            <!-- Status Message -->
            <div id="statusMessage" class="mt-4 hidden"></div>
        </div>
        
        <!-- Common Secrets Guide -->
        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <h3 class="text-lg font-medium text-blue-900 dark:text-blue-100 mb-3">üîë Common Secrets</h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded">
                    <div>
                        <span class="font-medium">FLY_API_TOKEN</span>
                        <p class="text-gray-600 dark:text-gray-400 text-xs">Fly.io API token for deployments</p>
                    </div>
                    <span class="text-xs text-gray-500">Required for deployment</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded">
                    <div>
                        <span class="font-medium">GITHUB_TOKEN</span>
                        <p class="text-gray-600 dark:text-gray-400 text-xs">GitHub Personal Access Token</p>
                    </div>
                    <span class="text-xs text-gray-500">Required for GitHub integration</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 rounded">
                    <div>
                        <span class="font-medium">ANTHROPIC_AUTH_TOKEN</span>
                        <p class="text-gray-600 dark:text-gray-400 text-xs">Claude API authentication</p>
                    </div>
                    <span class="text-xs text-gray-500">Required for Claude integration</span>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex flex-wrap gap-3">
            <a href="/config/status" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors duration-200">
                üîç Check ENV Status
            </a>
            <a href="/config/" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg transition-colors duration-200">
                ‚Üê Back to Config
            </a>
        </div>
    </div>
    
    {{.Footer}}
    
    <script>
        // Handle custom key field visibility
        document.getElementById('key').addEventListener('change', function() {
            const customField = document.getElementById('customKeyField');
            if (this.value === 'CUSTOM') {
                customField.classList.remove('hidden');
                document.getElementById('customKey').required = true;
            } else {
                customField.classList.add('hidden');
                document.getElementById('customKey').required = false;
                document.getElementById('customKey').value = '';
            }
        });
        
        // Handle form submission
        document.getElementById('secretForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const statusDiv = document.getElementById('statusMessage');
            
            // Determine the actual key to use
            let key = formData.get('key');
            if (key === 'CUSTOM') {
                key = formData.get('customKey');
                if (!key) {
                    showStatus('‚ùå Please enter a custom variable name', 'error');
                    return;
                }
            }
            
            // Show loading state
            showStatus('üîÑ Storing secret...', 'info');
            
            try {
                const response = await fetch('/config/api/secrets/set', {
                    method: 'POST',
                    body: JSON.stringify({
                        key: key,
                        value: formData.get('value')
                    }),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showStatus('‚úÖ Secret stored successfully in keychain!', 'success');
                    document.getElementById('value').value = '';
                    // Reset form
                    document.getElementById('key').value = 'FLY_API_TOKEN';
                    document.getElementById('customKeyField').classList.add('hidden');
                    document.getElementById('customKey').required = false;
                } else {
                    const error = await response.text();
                    showStatus('‚ùå Failed to store secret: ' + error, 'error');
                }
            } catch (err) {
                showStatus('‚ùå Network error: ' + err.message, 'error');
            }
        });
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.classList.remove('hidden');
            
            // Remove existing classes
            statusDiv.className = 'mt-4 p-3 rounded-lg text-sm';
            
            // Add appropriate styling
            if (type === 'success') {
                statusDiv.className += ' bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700';
            } else if (type === 'error') {
                statusDiv.className += ' bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700';
            } else {
                statusDiv.className += ' bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700';
            }
            
            statusDiv.textContent = message;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
</body>
</html>