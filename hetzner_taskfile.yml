
# https://taskfile.dev

# https://taskfile.dev/reference/cli

## Hetzer Cloud CLI Taskfile

# https://github.com/hetznercloud/cli

# This Taskfile manages the installation and configuration of the Hetzner Cloud CLI (hcloud).
# It provides tasks for installing, configuring, and managing Hetzner Cloud resources.
# It supports multiple platforms (macOS, Linux, Windows) and is designed to be idempotent.
# The tasks include installation, configuration, server management, network management, and more.



version: '3'

vars:
  BINARY_NAME: hcloud
  HCLOUD_VERSION: v1.51.0
  INSTALL_DIR: "{{.USER_WORKING_DIR}}/.dep"

tasks:
  # Default task to show help
  default:
    desc: Show available tasks
    cmds:
      - task --list-all

### DEP
  

  dep:
    desc: Install hcloud CLI
    preconditions:
      - sh: '! command -v hcloud >/dev/null 2>&1'
        msg: 'hcloud is already installed'
    cmds:
      - cmd: |
          mkdir -p {{.INSTALL_DIR}}
          curl -LO https://github.com/hetznercloud/cli/releases/download/{{.HCLOUD_VERSION}}/hcloud-darwin-amd64.tar.gz
          tar -xzf hcloud-darwin-amd64.tar.gz
          mv hcloud {{.INSTALL_DIR}}/hcloud-darwin-amd64
          rm hcloud-darwin-amd64.tar.gz
          chmod +x {{.INSTALL_DIR}}/hcloud-darwin-amd64
          ln -sf {{.INSTALL_DIR}}/hcloud-darwin-amd64 {{.INSTALL_DIR}}/hcloud
        platforms: [darwin]
      - cmd: |
          mkdir -p {{.INSTALL_DIR}}
          curl -LO https://github.com/hetznercloud/cli/releases/download/{{.HCLOUD_VERSION}}/hcloud-linux-amd64.tar.gz
          tar -xzf hcloud-linux-amd64.tar.gz
          mv hcloud {{.INSTALL_DIR}}/hcloud-linux-amd64
          rm hcloud-linux-amd64.tar.gz
          chmod +x {{.INSTALL_DIR}}/hcloud-linux-amd64
          ln -sf {{.INSTALL_DIR}}/hcloud-linux-amd64 {{.INSTALL_DIR}}/hcloud
        platforms: [linux]
      - cmd: |
          if (Get-Command winget -ErrorAction SilentlyContinue) {
            winget install hetznercloud.hcloud-cli
          } else {
            $url = "https://github.com/hetznercloud/cli/releases/download/{{.HCLOUD_VERSION}}/hcloud-windows-amd64.zip"
            $output = "$env:TEMP\hcloud-windows-amd64.zip"
            $extractPath = "$env:TEMP\hcloud"
            
            Invoke-WebRequest -Uri $url -OutFile $output
            Expand-Archive -Path $output -DestinationPath $extractPath -Force
            
            New-Item -ItemType Directory -Path "{{.INSTALL_DIR}}" -Force
            Copy-Item "$extractPath\hcloud.exe" "{{.INSTALL_DIR}}\{{.BINARY_NAME}}-windows-amd64.exe" -Force
            Copy-Item "$extractPath\hcloud.exe" "{{.INSTALL_DIR}}\{{.BINARY_NAME}}.exe" -Force
            Remove-Item $output -Force
            Remove-Item $extractPath -Recurse -Force
          }
        platforms: [windows]

  dep:del:
    desc: Uninstall the Hetzner Cloud CLI
    prompt: "Are you sure you want to uninstall hcloud?"
    cmds:
      - cmd: |
          rm -f {{.INSTALL_DIR}}/{{.BINARY_NAME}}-darwin-amd64 {{.INSTALL_DIR}}/{{.BINARY_NAME}}-linux-amd64 {{.INSTALL_DIR}}/{{.BINARY_NAME}}
        platforms: [darwin, linux]
      - cmd: |
          if (Get-Command winget -ErrorAction SilentlyContinue) {
            winget uninstall hetznercloud.hcloud-cli
          } else {
            Remove-Item "{{.INSTALL_DIR}}\{{.BINARY_NAME}}-windows-amd64.exe" -Force -ErrorAction SilentlyContinue
            Remove-Item "{{.INSTALL_DIR}}\{{.BINARY_NAME}}.exe" -Force -ErrorAction SilentlyContinue
          }
        platforms: [windows]

  # Configuration tasks
  config:
    desc: Configure hcloud with API token
    cmds:
      - cmd: |
          if [ -z "$HCLOUD_TOKEN" ]; then
            printf "Please set HCLOUD_TOKEN environment variable or run - hcloud context create\n"
            hcloud context create
          else
            printf "Using HCLOUD_TOKEN from environment\n"
            hcloud context create --name default --token "$HCLOUD_TOKEN"
          fi
        platforms: [darwin, linux]
      - cmd: |
          if (-not $env:HCLOUD_TOKEN) {
            Write-Host "Please set HCLOUD_TOKEN environment variable or run - hcloud context create" -ForegroundColor Yellow
            hcloud context create
          } else {
            Write-Host "Using HCLOUD_TOKEN from environment" -ForegroundColor Green
            hcloud context create --name default --token $env:HCLOUD_TOKEN
          }
        platforms: [windows]

  config:list:
    desc: List hcloud contexts
    cmds:
      - hcloud context list

  config:active:
    desc: Show active context
    cmds:
      - hcloud context active

  # Server management tasks
  server:list:
    desc: List all servers
    cmds:
      - hcloud server list

  server:create:
    desc: Create a new server (interactive)
    cmds:
      - cmd: |
          printf "Creating a new server...\n"
          printf "Available server types:\n"
          hcloud server-type list
          printf "\n"
          printf "Available images:\n"
          hcloud image list --type system | head -10
          printf "\n"
          read -p "Server name: " name
          read -p "Server type (e.g., cx11): " type
          read -p "Image (e.g., ubuntu-22.04): " image
          read -p "Location (e.g., fsn1): " location
          hcloud server create --name "$name" --type "$type" --image "$image" --location "$location"
        platforms: [darwin, linux]
      - cmd: |
          Write-Host "Creating a new server..." -ForegroundColor Green
          Write-Host "Available server types:" -ForegroundColor Yellow
          hcloud server-type list
          Write-Host ""
          Write-Host "Available images:" -ForegroundColor Yellow
          hcloud image list --type system | Select-Object -First 10
          Write-Host ""
          $name = Read-Host "Server name"
          $type = Read-Host "Server type (e.g., cx11)"
          $image = Read-Host "Image (e.g., ubuntu-22.04)"
          $location = Read-Host "Location (e.g., fsn1)"
          hcloud server create --name "$name" --type "$type" --image "$image" --location "$location"
        platforms: [windows]

  server:delete:
    desc: Delete a server by name. Usage - task server:delete -- <server-name>
    cmds:
      - hcloud server delete {{.CLI_ARGS}}

  server:ssh:
    desc: SSH into a server. Usage - task server:ssh -- <server-name>
    cmds:
      - hcloud server ssh {{.CLI_ARGS}}

  # Network tasks
  network:list:
    desc: List all networks
    cmds:
      - hcloud network list

  # Volume tasks
  volume:list:
    desc: List all volumes
    cmds:
      - hcloud volume list

  # Firewall tasks
  firewall:list:
    desc: List all firewalls
    cmds:
      - hcloud firewall list

  # Load balancer tasks
  lb:list:
    desc: List all load balancers
    cmds:
      - hcloud load-balancer list

  # Generic hcloud command runner
  run:
    desc: Runs a Hetzner Cloud CLI command. Example - task run -- server list
    cmds:
      - hcloud {{.CLI_ARGS}}

  # Development environment setup
  dev:setup:
    desc: Setup development environment with basic server
    cmds:
      - cmd: |
          printf "Setting up development environment...\n"
          SERVER_NAME="dev-$(date +%s)"
          hcloud server create \
            --name "$SERVER_NAME" \
            --type cx11 \
            --image ubuntu-22.04 \
            --location fsn1 \
            --ssh-key $(hcloud ssh-key list -o noheader | head -1 | awk '{print $1}') \
            --user-data-from-file cloud-init.yml 2>/dev/null || \
          hcloud server create \
            --name "$SERVER_NAME" \
            --type cx11 \
            --image ubuntu-22.04 \
            --location fsn1
          printf "‚úÖ Development server '%s' created\n" "$SERVER_NAME"
        platforms: [darwin, linux]
      - cmd: |
          Write-Host "Setting up development environment..." -ForegroundColor Green
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          $SERVER_NAME = "dev-$timestamp"
          
          # Try with SSH key first, fallback without
          $sshKeys = hcloud ssh-key list -o noheader
          if ($sshKeys) {
            $firstKey = ($sshKeys | Select-Object -First 1) -split '\s+' | Select-Object -First 1
            try {
              if (Test-Path "cloud-init.yml") {
                hcloud server create --name "$SERVER_NAME" --type cx11 --image ubuntu-22.04 --location fsn1 --ssh-key $firstKey --user-data-from-file cloud-init.yml
              } else {
                hcloud server create --name "$SERVER_NAME" --type cx11 --image ubuntu-22.04 --location fsn1 --ssh-key $firstKey
              }
            } catch {
              hcloud server create --name "$SERVER_NAME" --type cx11 --image ubuntu-22.04 --location fsn1
            }
          } else {
            hcloud server create --name "$SERVER_NAME" --type cx11 --image ubuntu-22.04 --location fsn1
          }
          Write-Host "‚úÖ Development server '$SERVER_NAME' created" -ForegroundColor Green
        platforms: [windows]

  dev:teardown:
    desc: Teardown development servers
    prompt: This will delete all servers with 'dev-' prefix. Continue?
    cmds:
      - cmd: |
          printf "Deleting development servers...\n"
          hcloud server list -o noheader | grep "^dev-" | awk '{print $1}' | while read server; do
            printf "Deleting %s...\n" "$server"
            hcloud server delete "$server"
          done
          printf "‚úÖ Development servers deleted\n"
        platforms: [darwin, linux]
      - cmd: |
          Write-Host "Deleting development servers..." -ForegroundColor Yellow
          $servers = hcloud server list -o noheader | Where-Object { $_ -match "^dev-" }
          foreach ($server in $servers) {
            $serverName = ($server -split '\s+')[0]
            Write-Host "Deleting $serverName..." -ForegroundColor Red
            hcloud server delete "$serverName"
          }
          Write-Host "‚úÖ Development servers deleted" -ForegroundColor Green
        platforms: [windows]

  # Status and info tasks
  status:
    desc: Show overall Hetzner Cloud status
    cmds:
      - cmd: |
          printf "=== Hetzner Cloud Status ===\n"
          printf "\n"
          printf "üìä Servers:\n"
          hcloud server list
          printf "\n"
          printf "üåê Networks:\n"
          hcloud network list
          printf "\n"
          printf "üíæ Volumes:\n"
          hcloud volume list
          printf "\n"
          printf "üî• Firewalls:\n"
          hcloud firewall list
          printf "\n"
          printf "‚öñÔ∏è  Load Balancers:\n"
          hcloud load-balancer list

  pricing:
    desc: Show pricing information
    cmds:
      - cmd: |
          printf "=== Server Types & Pricing ===\n"
          hcloud server-type list
          printf "\n"
          printf "=== Volume Pricing ===\n"
          printf "Volumes: ‚Ç¨0.0476/GB/month\n"
          printf "\n"
          printf "=== Traffic Pricing ===\n"
          printf "Outbound traffic: ‚Ç¨1.00/TB (first 21TB free per server)\n"

  # Backup and snapshot tasks
  backup:create:
    desc: Create backup of server. Usage - task backup:create -- <server-name>
    cmds:
      - hcloud server create-image --description "Backup-$(date +%Y%m%d-%H%M%S)" {{.CLI_ARGS}}

  backup:list:
    desc: List all backups/images
    cmds:
      - hcloud image list --type backup