# https://taskfile.dev

# Atlantis Terraform Pull Request Automation
# https://github.com/runatlantis/atlantis
# https://www.runatlantis.io/docs.html

version: '3'

vars:
  ATLANTIS_VERSION: v0.35.0
  ATLANTIS_IMAGE: ghcr.io/runatlantis/atlantis:{{.ATLANTIS_VERSION}}
  ATLANTIS_PORT: 4141

tasks:
  default:
    desc: Show available Atlantis tasks
    cmds:
      - echo
      - echo "Atlantis Terraform Pull Request Automation"
      - echo "Image     {{.ATLANTIS_IMAGE}}"
      - echo
      - task --list-all
      - echo
    silent: true

  ### DEPENDENCIES ###

  dep:
    desc: Pull Atlantis Docker image
    cmds:
      - docker pull {{.ATLANTIS_IMAGE}}

  dep:del:
    desc: Remove Atlantis Docker image
    cmds:
      - docker rmi {{.ATLANTIS_IMAGE}}

  ### RUN ###

  run:
    desc: Run Atlantis server (usage - task atlantis:run GITHUB_TOKEN=xxx WEBHOOK_SECRET=xxx)
    vars:
      GITHUB_TOKEN: '{{.GITHUB_TOKEN}}'
      WEBHOOK_SECRET: '{{.WEBHOOK_SECRET}}'
      ATLANTIS_URL: '{{.ATLANTIS_URL | default "http://localhost:4141"}}'
    preconditions:
      - sh: '[ -n "{{.GITHUB_TOKEN}}" ]'
        msg: 'GITHUB_TOKEN variable is required'
      - sh: '[ -n "{{.WEBHOOK_SECRET}}" ]'
        msg: 'WEBHOOK_SECRET variable is required'
    cmds:
      - |
        docker run --rm -it \
          -p {{.ATLANTIS_PORT}}:4141 \
          -e ATLANTIS_GH_TOKEN={{.GITHUB_TOKEN}} \
          -e ATLANTIS_GH_WEBHOOK_SECRET={{.WEBHOOK_SECRET}} \
          -e ATLANTIS_ATLANTIS_URL={{.ATLANTIS_URL}} \
          -v {{.USER_WORKING_DIR}}:/atlantis-data \
          {{.ATLANTIS_IMAGE}} server