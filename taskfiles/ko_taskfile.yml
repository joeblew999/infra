
# yaml-language-server: $schema=https://taskfile.dev/schema.json

# ko.taskfile.yml 
## doc : https://ko.build/configuration/


# task -d taskfiles/ko_taskfile.yml --list-all


version: '3'

env:
  #KO_DOCKER_REPO: gcr.io/my-project
  KO_DOCKER_REPO: ghcr.io/joeblew999/pb-stack

vars:
  # https://github.com/ko-build/ko
  KO__BINARY_NAME: ko
  KO__BINARY_NAME_NATIVE: '{{if eq OS "windows"}}ko.exe{{else}}ko{{end}}'
  # https://github.com/ko-build/ko/releases/tag/v0.18.0
  KO__VERSION: v0.18.0
  KO__INSTALL_DIR: "{{.TASK_DIR}}/.dep"
  KO__WHICH: ''
  KO__WHICH_VERSION: ''
  


tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list-all
    silent: true

  vars:
    desc: Show taskfile variables
    cmds:
      - cmd: |
          echo ""
          echo "KO Variables"
          echo "KO__BINARY_NAME              {{.KO__BINARY_NAME}}"
          echo "KO__BINARY_NAME_NATIVE       {{.KO__BINARY_NAME_NATIVE}}"
          echo "KO__VERSION                  {{.KO__VERSION}}"
          echo "KO__INSTALL_DIR              {{.KO__INSTALL_DIR}}"
          echo "KO__WHICH                   {{.KO__WHICH}}"
          echo "KO__WHICH_VERSION           {{.KO__WHICH_VERSION}}"
          echo ""
    silent: true

### dep

  dep:
    cmds:
      - go install github.com/google/ko@{{.KO__VERSION}}
  dep:del:
    cmds:
      - rm -f {{.BASE_DEP_PATH}}/{{.KO_BIN_NAME}}
      - ls -al {{.BASE_DEP_PATH}}/{{.KO_BIN_NAME}}
  dep:which:
    cmds:
      - task base:shell-which -- {{.KO_BIN_NAME}}
  dep:which:version:
    cmds:
      - '{{.KO_BIN_NAME}} version'

### run 

  bin:
    desc: Build the image with ko locally
    cmds:
      - ko build --platform linux/amd64,linux/arm64 --local {{.GO_VAR_SRC_MAIN_PATH}}
      #- ko build 
  run:
    desc: runs the image with ko locally
    cmds:
      - ko run {{.GO_VAR_SRC_MAIN_PATH}} --platform linux/amd64,linux/arm64
      #- ko build 


  run:init:
    cmds:
      # no sure i need this crap..
      - touch .ko.yaml