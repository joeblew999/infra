

# https://taskfile.dev

# Refernence dummy task file to check best practices.

# we use https://github.com/magefile/mage/releases/tag/v1.15.0

version: '3'

vars:
  DUMMY__BINARY_NAME: "mage"
  DUMMY__BINARY_NAME_NATIVE: '{{.DUMMY__BINARY_NAME}}{{if eq OS "windows"}}.exe{{end}}'
  DUMMY__VERSION: "v1.15.0"
  DUMMY__INSTALL_DIR: "{{.TASK_DIR}}/.dep"

tasks:
  default:
    desc: List available tasks
    cmds:
      - echo
      - echo "Basic commands "
      - echo
      - task --list-all
      - echo
    silent: true

  vars:
    desc: Show taskfile variables
    cmds:
      - cmd: |
          echo "DUMMY__BINARY_NAME         {{.DUMMY__BINARY_NAME}}"
          echo "DUMMY__BINARY_NAME_NATIVE  {{.DUMMY__BINARY_NAME_NATIVE}}"
          echo "DUMMY__VERSION             {{.DUMMY__VERSION}}"
          echo "DUMMY__INSTALL_DIR         {{.DUMMY__INSTALL_DIR}}"
    silent: true

  eget:bootstrap:
    desc: Bootstrap eget for binary downloads
    preconditions:
      - sh: '! command -v eget >/dev/null 2>&1'
        msg: 'eget is already installed'
    cmds:
      - cmd: |
          mkdir -p {{.DUMMY__INSTALL_DIR}}
          curl -LO https://github.com/zyedidia/eget/releases/latest/download/eget-1.3.4-darwin-amd64.tar.gz
          tar -xzf eget-1.3.4-darwin-amd64.tar.gz
          mv eget {{.DUMMY__INSTALL_DIR}}/eget
          rm eget-1.3.4-darwin-amd64.tar.gz
          chmod +x {{.DUMMY__INSTALL_DIR}}/eget
        platforms: [darwin]
      - cmd: |
          mkdir -p {{.DUMMY__INSTALL_DIR}}
          curl -LO https://github.com/zyedidia/eget/releases/latest/download/eget-1.3.4-linux-amd64.tar.gz
          tar -xzf eget-1.3.4-linux-amd64.tar.gz
          mv eget {{.DUMMY__INSTALL_DIR}}/eget
          rm eget-1.3.4-linux-amd64.tar.gz
          chmod +x {{.DUMMY__INSTALL_DIR}}/eget
        platforms: [linux]
      - cmd: |
          mkdir -p {{.DUMMY__INSTALL_DIR}}
          curl -LO https://github.com/zyedidia/eget/releases/latest/download/eget-1.3.4-windows-amd64.zip
          unzip -o eget-1.3.4-windows-amd64.zip
          mv eget.exe {{.DUMMY__INSTALL_DIR}}/eget.exe
          rm eget-1.3.4-windows-amd64.zip
        platforms: [windows]

  dep:
    desc: Install mage CLI using eget
    deps: [eget:bootstrap]
    preconditions:
      - echo "starting...."
      - sh: '! command -v mage >/dev/null 2>&1'
        msg: 'mage is already installed'
    cmds:
      - cmd: |
          mkdir -p {{.DUMMY__INSTALL_DIR}}
          {{.DUMMY__INSTALL_DIR}}/eget magefile/mage --to {{.DUMMY__INSTALL_DIR}} --file {{.DUMMY__BINARY_NAME_NATIVE}}
    defer:
      - echo "finished."
      - ls -al {{.DUMMY__INSTALL_DIR}}

  dep:del:
    desc: Uninstall the mage CLI
    prompt: "Are you sure you want to uninstall mage?"
    cmds:
      - cmd: |
          rm -f {{.DUMMY__INSTALL_DIR}}/{{.DUMMY__BINARY_NAME}}-darwin-amd64 {{.DUMMY__INSTALL_DIR}}/{{.DUMMY__BINARY_NAME}}-linux-amd64 {{.DUMMY__INSTALL_DIR}}/{{.DUMMY__BINARY_NAME}}
        platforms: [darwin, linux]
      - cmd: |
          Remove-Item "{{.DUMMY__INSTALL_DIR}}\{{.DUMMY__BINARY_NAME}}-windows-amd64.exe" -Force -ErrorAction SilentlyContinue
          Remove-Item "{{.DUMMY__INSTALL_DIR}}\{{.DUMMY__BINARY_NAME}}.exe" -Force -ErrorAction SilentlyContinue
        platforms: [windows]
          